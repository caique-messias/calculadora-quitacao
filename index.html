<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora de Quita√ß√£o de Parcelas (Price/SAC) ‚Äî Economize Juros</title>
<meta name="description" content="Descubra quanto de juros voc√™ economiza ao quitar/antecipar parcelas de financiamento. Compare reduzir prazo vs reduzir parcela em Price e veja linhas em SAC.">
<meta property="og:title" content="Calculadora de Quita√ß√£o ‚Äî Economize Juros">
<meta property="og:description" content="Simule sua economia ao quitar tudo agora ou antecipar √∫ltimas parcelas. Compare estrat√©gias lado a lado.">
<meta property="og:type" content="website">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='52' x='6' font-size='56'%3E%24%3C/text%3E%3C/svg%3E">
<style>
  :root{--bg:#0b1220;--card:#0f172a;--txt:#e5e7eb;--muted:#9ca3af;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--stroke:#1f2937;--field:#0b1220}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1024px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border-radius:18px;padding:18px 16px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:22px}
  p.lead{margin:0 0 6px;color:var(--muted)}
  .row{display:grid;gap:12px}
  @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
  label{display:flex;align-items:center;gap:6px;margin:10px 0 6px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}
  input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:var(--field);color:var(--txt);outline:none}
  input:focus,select:focus{border-color:#334155;box-shadow:0 0 0 3px rgba(51,65,85,.35)}
  button{cursor:pointer}
  .btn{background:#1f2937;border-color:#334155}
  .btn:hover{filter:brightness(1.08)}
  .result{margin-top:16px;padding:14px;border-radius:12px;background:#0b1220;border:1px solid var(--stroke)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)} .muted{color:var(--muted)}
  .inline-help{display:inline-block;border:1px solid var(--stroke);border-radius:8px;padding:6px 8px;margin-left:auto;font-size:12px;color:var(--muted)}
  .kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .foot{margin-top:18px;font-size:12px;color:var(--muted)}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px}
  .box{display:none;margin-top:10px;border:1px solid var(--stroke);border-radius:12px;padding:12px;background:#0b1220}
  .side{display:grid;gap:12px}
  @media(min-width:900px){.side{grid-template-columns:1fr 1fr}}
  .panel{border:1px solid var(--stroke);border-radius:12px;padding:12px;background:#0b1220}
  .panel h3{margin:0 0 8px;font-size:16px}
  canvas{width:100%;height:220px;background:#0b1220;border:1px solid var(--stroke);border-radius:12px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div>
        <h1>Calculadora de Quita√ß√£o / Antecipa√ß√£o</h1>
        <p class="lead">Compare <b>reduzir prazo</b> vs <b>reduzir parcela</b> (Price). Em SAC, veja linhas antes/depois.</p>
      </div>
      <span class="inline-help">Dica: parcelas iguais ‚Üí <b>Price</b>. Parcelas caem ‚Üí <b>SAC</b>.</span>
    </div>

    <fieldset class="row" style="margin-top:8px">
      <div>
        <label for="tipo">Tipo do financiamento</label>
        <select id="tipo">
          <option value="price" selected>Price (parcelas iguais)</option>
          <option value="sac">SAC (parcelas que caem)</option>
        </select>
      </div>
      <div>
        <label for="parcela">Valor da parcela atual (R$)</label>
        <input id="parcela" inputmode="decimal" placeholder="Ex.: 1.200,00" />
        <div class="hint">No app/boleto aparece como ‚Äúvalor da parcela‚Äù.</div>
      </div>
    </fieldset>

    <fieldset class="row">
      <div>
        <label for="n">Parcelas restantes (N)</label>
        <input id="n" inputmode="numeric" placeholder="Ex.: 24" />
      </div>
      <div>
        <label for="saldo">Saldo devedor (opcional)</label>
        <input id="saldo" inputmode="decimal" placeholder="Ex.: 22.500,00" />
        <div class="hint">Se informar, calculamos mesmo sem a taxa.</div>
      </div>
    </fieldset>

    <fieldset class="row">
      <div>
        <label for="taxaMes">Taxa ao m√™s % (opcional)</label>
        <input id="taxaMes" inputmode="decimal" placeholder="Ex.: 1,49" />
      </div>
      <div>
        <label for="cetAno">ou CET ao ano % (opcional)</label>
        <input id="cetAno" inputmode="decimal" placeholder="Ex.: 22,5" />
        <div class="hint">Converteremos para m√™s automaticamente.</div>
      </div>
    </fieldset>

    <!-- ANTECIPAR V√ÅRIAS PARCELAS -->
    <fieldset class="row">
      <div>
        <label for="modo">O que antecipar?</label>
        <select id="modo">
          <option value="tudo" selected>Quitar tudo agora</option>
          <option value="ultimas">Antecipar √∫ltimas parcelas</option>
        </select>
      </div>
      <div id="kBox" style="display:none">
        <label for="k">Quantas parcelas finais antecipar?</label>
        <input id="k" inputmode="numeric" placeholder="Ex.: 3" />
        <div class="hint">At√© o m√°ximo de N.</div>
      </div>
    </fieldset>

    <!-- OP√á√ïES AVAN√áADAS (inicia OCULTO) -->
    <fieldset class="row">
      <div>
        <label>Op√ß√µes avan√ßadas</label>
        <button type="button" id="advToggle" class="btn">Mostrar op√ß√µes</button>
        <div id="advBox" class="box" style="display:none">
          <label style="margin-top:0; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="advMultaOn" />
            Considerar ‚Äútaxa/multa de quita√ß√£o‚Äù
          </label>
          <input id="multa" inputmode="decimal" placeholder="Ex.: 2 (em %)" />
          <div class="hint">‚ö†Ô∏è Em contratos atuais √© incomum haver multa relevante. Confirme no contrato.</div>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="btn" class="btn" style="width:100%">Calcular</button>
      </div>
    </fieldset>

    <!-- RESULTADO RESUMO -->
    <div id="out" class="result" style="display:none"></div>

    <!-- COMPARA√á√ÉO LADO A LADO (s√≥ aparece ap√≥s Calcular) -->
    <div id="compare" class="side" style="display:none">
      <div class="panel" id="panelPrazo">
        <h3>üí° Reduzir prazo</h3>
        <div id="outPrazo"></div>
        <canvas id="chartPrazo" aria-label="Meses antes vs depois"></canvas>
      </div>
      <div class="panel" id="panelParcela">
        <h3>üí° Reduzir parcela</h3>
        <div id="outParcela"></div>
        <canvas id="chartParcela" aria-label="Parcela antes vs depois"></canvas>
      </div>
    </div>

    <!-- EXPLICATIVO -->
    <div class="box" id="expBox" style="display:block; margin-top:12px">
      <p><b>Reduzir prazo:</b> voc√™ paga algumas parcelas agora e <b>corta meses do final</b>. O valor da parcela mensal fica igual; termina antes ‚Äî economiza os juros dos meses finais.</p>
      <p><b>Reduzir parcela (Price):</b> voc√™ paga agora e mant√©m o mesmo prazo. O sistema recalcula uma <b>parcela menor</b> para os meses restantes.</p>
      <p>Em <b>SAC</b>, normalmente a antecipa√ß√£o reduz o prazo.</p>
    </div>

    <!-- GR√ÅFICO GERAL (outros modos) -->
    <canvas id="chart" aria-label="Gr√°fico geral"></canvas>

    <div class="foot">
      ‚ö†Ô∏è <b>Aviso:</b> Resultado educativo/estimado. Regras espec√≠ficas do seu contrato podem alterar valores. Confirme com sua institui√ß√£o antes de decidir.
    </div>
  </div>
</div>

<script>
  // ===== Helpers =====
  const brToNumber = (s) => {
    if(!s) return NaN;
    return Number(String(s).replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''));
  };
  const fmtBRL = (v) => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtPct  = (v) => (v*100).toLocaleString('pt-BR',{maximumFractionDigits:3}) + '%';

  const anualParaMes = a => Math.pow(1+a,1/12)-1;
  const pvPrice = (A,i,N) => A*(1 - Math.pow(1+i,-N))/i;
  const pagamentoPrice = (PV,i,N) => PV * i / (1 - Math.pow(1+i,-N));

  // m√°scaras leves
  ['parcela','saldo'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('blur', ()=> {
      const n = brToNumber(el.value);
      if(!isNaN(n) && el.value.trim()!=='') el.value = n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    });
  });
  ['taxaMes','cetAno','multa'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('blur', ()=> {
      const n = brToNumber(el.value);
      if(!isNaN(n) && el.value.trim()!=='') el.value = n.toLocaleString('pt-BR',{maximumFractionDigits:3});
    });
  });

  // Op√ß√µes avan√ßadas (come√ßa oculto)
  document.getElementById('advToggle').onclick = () => {
    const box = document.getElementById('advBox');
    const opened = box.style.display === 'block';
    box.style.display = opened ? 'none' : 'block';
    document.getElementById('advToggle').textContent = opened ? 'Mostrar op√ß√µes' : 'Ocultar op√ß√µes';
  };

  // Quando troca para "√∫ltimas", s√≥ mostra o campo K. Os pain√©is de compara√ß√£o ficam escondidos at√© calcular.
  document.getElementById('modo').onchange = () => {
    const modo = document.getElementById('modo').value;
    document.getElementById('kBox').style.display = (modo==='ultimas') ? 'block' : 'none';
    document.getElementById('compare').style.display = 'none';
    clearCanvas('chart'); clearCanvas('chartPrazo'); clearCanvas('chartParcela');
    document.getElementById('out').style.display = 'none';
  };

  // ===== C√°lculos =====
  function economiaPriceTudo(A,N,PV,i){
    let usadoPV = PV;
    if(!(usadoPV>0)){
      if(!(i>0)) return {erro:"Para <b>Price</b>, informe <b>Saldo</b> ou <b>Taxa</b>."};
      usadoPV = pvPrice(A,i,N);
    }
    const economiaBruta = (A*N) - usadoPV;
    return {economiaBruta, usadoPV, i};
  }

  function anteciparUltimasPrice_duplo(A,N,i,k,PV,multaPct){
    if(!(i>0)) return {erro:"Para antecipar √∫ltimas parcelas (Price), informe a <b>Taxa</b> (ou CET)."};
    if(!(k>0) || k>N) return {erro:"Informe um n√∫mero v√°lido de parcelas a antecipar (at√© N)."};

    let pvSum = 0;
    for(let t=N-k+1; t<=N; t++) pvSum += A/Math.pow(1+i,t);
    const multa = (PV>0 && multaPct>0) ? PV*multaPct : 0;

    // Reduzir prazo
    const econPrazoBruta = A*k - pvSum;
    const econPrazoLiq   = econPrazoBruta - multa;
    const Nnovo = N - k;

    // Reduzir parcela
    const PVtotal = pvPrice(A,i,N);
    const PVnovo  = PVtotal - pvSum;
    const Anew    = pagamentoPrice(PVnovo, i, N);
    const totalAntes = A*N;
    const totalDepois = pvSum + (Anew*N);
    const econParcBruta = totalAntes - totalDepois;
    const econParcLiq   = econParcBruta - multa;

    return {
      prazo: { pagarHoje: pvSum + multa, economiaBruta: econPrazoBruta, economiaLiquida: econPrazoLiq, Nnovo, multa },
      parcela: { pagarHoje: pvSum + multa, economiaBruta: econParcBruta, economiaLiquida: econParcLiq, Aantigo: A, Anovo: Anew, multa }
    };
  }

  function economiaSACTudo(parcela, N, PV, i){
    if(!(PV>0)) return {erro:"Para <b>SAC</b>, informe o <b>Saldo</b>."};
    let taxa = i;
    if(!(taxa>0)){
      if(!(parcela>0)) return {erro:"Para <b>SAC</b>, informe <b>Taxa</b> ou a <b>parcela atual</b>."};
      taxa = (parcela/PV) - (1/N);
      if(!(taxa>0)) return {erro:"Dados insuficientes: revise parcela/saldo/N."};
    }
    const economiaBruta = taxa * PV * (N+1) / 2;
    return {economiaBruta, i:taxa};
  }

  function anteciparUltimasSAC(parcela,N,PV,i,k,multaPct){
    if(!(PV>0)) return {erro:"Para <b>SAC</b>, informe o <b>Saldo</b>."};
    let taxa = i;
    if(!(taxa>0)){
      if(!(parcela>0)) return {erro:"Para <b>SAC</b>, informe <b>Taxa</b> ou a <b>parcela atual</b>."};
      taxa = (parcela/PV) - (1/N);
      if(!(taxa>0)) return {erro:"Dados insuficientes: revise parcela/saldo/N."};
    }
    if(!(k>0) || k>N) return {erro:"Informe um n√∫mero v√°lido de parcelas a antecipar (at√© N)."};
    const econBruta = taxa * PV * (k*(k+1) / (2*N));
    const principalAgora = (PV/N) * k;
    const multa = (PV||0) * (multaPct||0);
    const econLiq = econBruta - multa;
    return { pagarHoje: principalAgora + multa, economiaBruta: econBruta, economiaLiquida: econLiq, Nnovo: N-k, multa, i: taxa };
  }

  // ===== Handler principal =====
  document.getElementById('btn').onclick = () => {
    const tipo   = document.getElementById('tipo').value;
    const A      = brToNumber(document.getElementById('parcela').value);
    const N      = parseInt((document.getElementById('n').value||'0').trim(),10);
    const PV     = brToNumber(document.getElementById('saldo').value);
    const iMes   = brToNumber(document.getElementById('taxaMes').value)/100;
    const iAno   = brToNumber(document.getElementById('cetAno').value)/100;
    const modo   = document.getElementById('modo').value;
    const k      = parseInt((document.getElementById('k').value||'0').trim(),10);
    const advMultaOn = document.getElementById('advMultaOn').checked;
    const multaPct   = advMultaOn ? (brToNumber(document.getElementById('multa').value)/100 || 0) : 0;

    let i = NaN;
    if(iMes>0) i = iMes; else if(iAno>0) i = anualParaMes(iAno);

    const out = document.getElementById('out');
    const compare = document.getElementById('compare');
    const outPrazo = document.getElementById('outPrazo');
    const outParcela = document.getElementById('outParcela');

    out.style.display = 'block';
    compare.style.display = 'none';
    clearCanvas('chart'); clearCanvas('chartPrazo'); clearCanvas('chartParcela');

    // valida√ß√µes
    if(!(N>0)){ out.innerHTML = "<span class='err'>Informe <b>Parcelas restantes (N)</b>.</span>"; return; }
    if(tipo==='price' && !(A>0)){ out.innerHTML = "<span class='err'>Informe o <b>valor da parcela</b>.</span>"; return; }
    if(modo==='ultimas' && !(k>0)){ out.innerHTML = "<span class='err'>Informe <b>quantas parcelas</b> antecipar.</span>"; return; }

    // C√°lculos
    if(tipo==='price'){
      if(modo==='tudo'){
        const r = economiaPriceTudo(A,N,PV,i);
        if(r.erro){ out.innerHTML = r.erro; return; }
        const multa = (r.usadoPV||0) * multaPct;
        const econLiquida = r.economiaBruta - multa;
        const cls = econLiquida < 0 ? 'err' : (multa ? 'warn' : 'ok');
        const lbl = econLiquida < 0 ? 'Diferen√ßa (pior que manter):' : 'Economia l√≠quida:';

        out.innerHTML = `
          <div class="kv"><div><b>Quitar tudo agora (Price)</b></div><span class="badge">${r.i>0?('Taxa: '+fmtPct(r.i)+' a.m.'):'Taxa estimada/‚Äî'}</span></div>
          <div>Somat√≥rio de parcelas futuras: <b>${fmtBRL(A*N)}</b></div>
          <div>Quitar hoje (aprox.): <b>${fmtBRL(r.usadoPV + (multa||0))}</b> ${multa?`<span class="muted">(inclui multa)</span>`:''}</div>
          <div class="ok">Economia de juros (bruta): <b>${fmtBRL(r.economiaBruta)}</b></div>
          ${multa?`<div>Multa: <b>${fmtBRL(multa)}</b> <span class="pill">op√ß√£o avan√ßada</span></div>`:''}
          <div class="${cls}"><b>${lbl}</b> <b>${fmtBRL(econLiquida)}</b></div>
        `;
        // gr√°fico geral: barras totais
        drawBarTotalsAsync('chart', A*N, 0);
        return;
      }

      if(modo==='ultimas'){
        const r = anteciparUltimasPrice_duplo(A,N,i,k,PV,multaPct);
        if(r.erro){ out.innerHTML = r.erro; return; }

        out.innerHTML = `
          <div class="kv"><div><b>Antecipar √∫ltimas ${k} parcelas (Price)</b></div><span class="badge">Compara√ß√£o lado a lado</span></div>
          <div class="muted">Vendo dois caminhos: <b>reduzir prazo</b> (meses caem) e <b>reduzir parcela</b> (parcela menor).</div>
        `;

        // Painel A ‚Äî Reduzir prazo (meses)
        const clsA = r.prazo.economiaLiquida < 0 ? 'err' : (r.prazo.multa ? 'warn' : 'ok');
        const lblA = r.prazo.economiaLiquida < 0 ? 'Diferen√ßa (pior que manter):' : 'Economia l√≠quida:';
        outPrazo.innerHTML = `
          <div>Meses antes: <b>${N}</b> ‚Ä¢ Meses depois: <b>${r.prazo.Nnovo}</b></div>
          <div>Voc√™ pagaria hoje: <b>${fmtBRL(r.prazo.pagarHoje)}</b> ${r.prazo.multa?`<span class="muted">(inclui multa)</span>`:''}</div>
          <div>Economia de juros (bruta): <b>${fmtBRL(r.prazo.economiaBruta)}</b></div>
          ${r.prazo.multa?`<div>Multa: <b>${fmtBRL(r.prazo.multa)}</b></div>`:''}
          <div class="${clsA}"><b>${lblA}</b> <b>${fmtBRL(r.prazo.economiaLiquida)}</b></div>
        `;

        // Painel B ‚Äî Reduzir parcela (parcela antes/depois)
        const clsB = r.parcela.economiaLiquida < 0 ? 'err' : (r.parcela.multa ? 'warn' : 'ok');
        const lblB = r.parcela.economiaLiquida < 0 ? 'Diferen√ßa (pior que manter):' : 'Economia l√≠quida:';
        outParcela.innerHTML = `
          <div>Parcela antes: <b>${fmtBRL(r.parcela.Aantigo)}</b> ‚Ä¢ Parcela depois: <b>${fmtBRL(r.parcela.Anovo)}</b></div>
          <div>Voc√™ pagaria hoje: <b>${fmtBRL(r.parcela.pagarHoje)}</b> ${r.parcela.multa?`<span class="muted">(inclui multa)</span>`:''}</div>
          <div>Economia de juros (bruta): <b>${fmtBRL(r.parcela.economiaBruta)}</b></div>
          ${r.parcela.multa?`<div>Multa: <b>${fmtBRL(r.parcela.multa)}</b></div>`:''}
          <div class="${clsB}"><b>${lblB}</b> <b>${fmtBRL(r.parcela.economiaLiquida)}</b></div>
        `;

        // mostra os pain√©is s√≥ agora
        compare.style.display = 'grid';

        // gr√°ficos ap√≥s layout (para garantir dimens√µes corretas)
        drawBarCustomAsync('chartPrazo', N, r.prazo.Nnovo, 'Meses antes', 'Meses depois');
        drawBarCustomAsync('chartParcela', r.parcela.Aantigo, r.parcela.Anovo, 'Parcela antes', 'Parcela depois');
        return;
      }
    }

    if(tipo==='sac'){
      document.getElementById('compare').style.display = 'none';
      if(modo==='tudo'){
        const r = economiaSACTudo(A,N,PV,i);
        if(r.erro){ out.innerHTML = r.erro; return; }
        const multa = (PV||0) * multaPct;
        const econLiquida = r.economiaBruta - multa;
        const cls = econLiquida < 0 ? 'err' : (multa ? 'warn' : 'ok');
        const lbl = econLiquida < 0 ? 'Diferen√ßa (pior que manter):' : 'Economia l√≠quida:';

        out.innerHTML = `
          <div class="kv"><div><b>Quitar tudo agora (SAC)</b></div><span class="badge">Taxa usada/estimada: ${fmtPct(r.i)} a.m.</span></div>
          <div>Juros que seriam pagos (estimativa): <b>${fmtBRL(r.economiaBruta)}</b></div>
          ${multa?`<div>Multa: <b>${fmtBRL(multa)}</b> <span class="pill">op√ß√£o avan√ßada</span></div>`:''}
          <div class="${cls}"><b>${lbl}</b> <b>${fmtBRL(econLiquida)}</b></div>
          <div class="muted">Saldo informado: ${fmtBRL(PV||0)} ‚Ä¢ Parcelas restantes: ${N}</div>
        `;
        drawLineAsync(seriesSAC(PV, r.i, N), []);
        return;
      }

      if(modo==='ultimas'){
        const r = anteciparUltimasSAC(A,N,PV,i,k,multaPct);
        if(r.erro){ out.innerHTML = r.erro; return; }
        const cls = r.economiaLiquida < 0 ? 'err' : (r.multa ? 'warn' : 'ok');
        const lbl = r.economiaLiquida < 0 ? 'Diferen√ßa (pior que manter):' : 'Economia l√≠quida:';

        out.innerHTML = `
          <div class="kv"><div><b>Antecipar √∫ltimas ${k} parcelas (SAC)</b></div><span class="badge">Reduzir prazo</span></div>
          <div>Voc√™ pagaria hoje (principal das ${k} √∫ltimas): <b>${fmtBRL((PV/N)*k + (r.multa||0))}</b> ${r.multa?`<span class="muted">(inclui multa)</span>`:''}</div>
          <div>Juros evitados (estimativa): <b>${fmtBRL(r.economiaBruta)}</b></div>
          ${r.multa?`<div>Multa: <b>${fmtBRL(r.multa)}</b></div>`:''}
          <div class="${cls}"><b>${lbl}</b> <b>${fmtBRL(r.economiaLiquida)}</b></div>
          <div class="muted">De ${N} ‚Üí ${r.Nnovo} parcelas. Em SAC mantemos o valor das primeiras e s√≥ reduzimos o prazo.</div>
        `;
        const taxa = r.i;
        const antes = seriesSAC(PV, taxa, N);
        const depois = seriesSAC(PV - (PV/N)*k, taxa, N - k);
        drawLineAsync(antes,depois);
        return;
      }
    }

    out.innerHTML = "Revise os dados.";
  };

  // S√©rie SAC (aproxima√ß√£o)
  function seriesSAC(PV,i,N){
    const arr=[], amort = PV/N; let saldo=PV;
    for(let t=1;t<=N;t++){ const juros = i>0 ? saldo*i : 0; arr.push(amort + juros); saldo -= amort; }
    return arr;
  }

  // ===== Canvas utils =====
  function clearCanvas(id){
    const c = document.getElementById(id); if(!c) return;
    const ctx = c.getContext('2d');
    const rect = c.getBoundingClientRect();
    const W = c.width = Math.max(1, Math.floor(rect.width * devicePixelRatio));
    const H = c.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));
    ctx.clearRect(0,0,W,H);
  }
  function withCtx(id){
    const c = document.getElementById(id);
    const ctx = c.getContext('2d');
    const rect = c.getBoundingClientRect();
    const W = c.width = Math.max(1, Math.floor(rect.width * devicePixelRatio));
    const H = c.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));
    return {c, ctx, W, H};
  }

  // Barras totais (antes/depois)
  function drawBarTotalsAsync(id, before, after){
    requestAnimationFrame(()=>drawBarTotals(id,before,after));
  }
  function drawBarTotals(id, before, after){
    const {ctx,W,H} = withCtx(id);
    const pad = 40*devicePixelRatio, maxV = Math.max(1,before,after);
    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='#1f2937'; ctx.beginPath();
    ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad);
    ctx.moveTo(pad,pad);   ctx.lineTo(pad,H-pad); ctx.stroke();

    const barW=(W-pad*2)/6, h1=(before/maxV)*(H-pad*2), h2=(after/maxV)*(H-pad*2);
    const x1=pad+barW, x2=W/2+barW;

    ctx.fillStyle='#64748b'; ctx.fillRect(x1,(H-pad)-h1,barW,h1);
    ctx.fillStyle= after<before ? '#16a34a' : (after>before ? '#ef4444' : '#94a3b8');
    ctx.fillRect(x2,(H-pad)-h2,barW,h2);

    ctx.fillStyle='#9ca3af'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.textAlign='center';
    ctx.fillText('Antes', x1+barW/2, pad-8*devicePixelRatio);
    ctx.fillText('Depois',x2+barW/2, pad-8*devicePixelRatio);
  }

  // Barras customizadas (meses / parcela)
  function drawBarCustomAsync(id,before,after,l1,l2){ requestAnimationFrame(()=>drawBarCustom(id,before,after,l1,l2)); }
  function drawBarCustom(id,before,after,l1,l2){
    const {ctx,W,H} = withCtx(id);
    const pad = 40*devicePixelRatio, maxV=Math.max(1,before,after);
    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='#1f2937'; ctx.beginPath();
    ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad);
    ctx.moveTo(pad,pad);   ctx.lineTo(pad,H-pad); ctx.stroke();

    const barW=(W-pad*2)/6, h1=(before/maxV)*(H-pad*2), h2=(after/maxV)*(H-pad*2);
    const x1=pad+barW, x2=W/2+barW;

    ctx.fillStyle='#64748b'; ctx.fillRect(x1,(H-pad)-h1,barW,h1);
    ctx.fillStyle= after<before ? '#16a34a' : (after>before ? '#ef4444' : '#94a3b8');
    ctx.fillRect(x2,(H-pad)-h2,barW,h2);

    ctx.fillStyle='#9ca3af'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.textAlign='center';
    ctx.fillText(l1, x1+barW/2, pad-8*devicePixelRatio);
    ctx.fillText(l2, x2+barW/2, pad-8*devicePixelRatio);
  }

  // Linhas (SAC)
  function drawLineAsync(a,b){ requestAnimationFrame(()=>drawLine(a,b)); }
  function drawLine(antes, depois){
    const {ctx,W,H} = withCtx('chart');
    const pad = 40*devicePixelRatio;
    const maxLen=Math.max(antes.length,depois.length,1);
    const maxV = Math.max(1, Math.max(...antes,0), Math.max(...depois,0));
    const step = (W - pad*2) / Math.max(1,(maxLen-1));

    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='#1f2937'; ctx.beginPath();
    ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad);
    ctx.moveTo(pad,pad);   ctx.lineTo(pad,H-pad); ctx.stroke();

    function plot(arr,color){
      if(arr.length===0) return;
      ctx.beginPath(); ctx.strokeStyle=color;
      for(let i=0;i<arr.length;i++){
        const x=pad+i*step; const y=(H-pad)-(arr[i]/maxV)*(H-pad*2);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
    plot(antes,'#94a3b8'); // antes
    plot(depois,'#22c55e'); // depois
  }
</script>
</body>
</html>
